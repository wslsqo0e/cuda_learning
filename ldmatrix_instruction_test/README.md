# ldmatrix\_instruction\_test

总结下核心要点:
`m8n8` 代表 8\*8 的 Tile
- `m8n8.x1`: 读取T0~T7所提供首地址的连续8个元素
- `m8n8.x2`: 读取T0~T7, T8~T15 所提供首地址的连续8个元素
- `m8n8.x3`: 读取T0~T7, T8~T15, T16~T23 所提供首地址的连续8个元素
- `m8n8.x4`: 读取T0~T7, T8~T15, T16~T23, T24~T31 所提供首地址的连续8个元素


## ldmatrix.sync.aligned.m8n8.x4
shared memory中存储的内容如下 (行优先存储)
数据类型是half，每行的8个元素刚好是 128 bits 的长度
```
0   1   2   3   4   5   6   7   | 8   9   10  11  12  13  14  15
16  17  18  19  20  21  22  23  | 24  25  26  27  28  29  30  31
32  33  34  35  36  37  38  39  | 40  41  42  43  44  45  46  47
48  49  50  51  52  53  54  55  | 56  57  58  59  60  61  62  63
64  65  66  67  68  69  70  71  | 72  73  74  75  76  77  78  79
80  81  82  83  84  85  86  87  | 88  89  90  91  92  93  94  95
96  97  98  99  100 101 102 103 | 104 105 106 107 108 109 110 111
112 113 114 115 116 117 118 119 | 120 121 122 123 124 125 126 127
----------------------------------------------------------------
128 129 130 131 132 133 134 135 | 136 137 138 139 140 141 142 143
144 145 146 147 148 149 150 151 | 152 153 154 155 156 157 158 159
160 161 162 163 164 165 166 167 | 168 169 170 171 172 173 174 175
176 177 178 179 180 181 182 183 | 184 185 186 187 188 189 190 191
192 193 194 195 196 197 198 199 | 200 201 202 203 204 205 206 207
208 209 210 211 212 213 214 215 | 216 217 218 219 220 221 222 223
224 225 226 227 228 229 230 231 | 232 233 234 235 236 237 238 239
240 241 242 243 244 245 246 247 | 248 249 250 251 252 253 254 255
```

按照上面示意的切分方式，总共有 32 个行首地址，如果我们按照如下的方式，将行首地址分配给warp的各个线程
```
T0:  0   1   2   3   4   5   6   7   | T16: 8   9   10  11  12  13  14  15
T1:  16  17  18  19  20  21  22  23  | T17: 24  25  26  27  28  29  30  31
T2:  32  33  34  35  36  37  38  39  | T18: 40  41  42  43  44  45  46  47
T3:  48  49  50  51  52  53  54  55  | T19: 56  57  58  59  60  61  62  63
T4:  64  65  66  67  68  69  70  71  | T20: 72  73  74  75  76  77  78  79
T5:  80  81  82  83  84  85  86  87  | T21: 88  89  90  91  92  93  94  95
T6:  96  97  98  99  100 101 102 103 | T22: 104 105 106 107 108 109 110 111
T7:  112 113 114 115 116 117 118 119 | T23: 120 121 122 123 124 125 126 127
--------------------------------------- -----------------------------------
T8:  128 129 130 131 132 133 134 135 | T24: 136 137 138 139 140 141 142 143
T9:  144 145 146 147 148 149 150 151 | T25: 152 153 154 155 156 157 158 159
T10: 160 161 162 163 164 165 166 167 | T26: 168 169 170 171 172 173 174 175
T11: 176 177 178 179 180 181 182 183 | T27: 184 185 186 187 188 189 190 191
T12: 192 193 194 195 196 197 198 199 | T28: 200 201 202 203 204 205 206 207
T13: 208 209 210 211 212 213 214 215 | T29: 216 217 218 219 220 221 222 223
T14: 224 225 226 227 228 229 230 231 | T30: 232 233 234 235 236 237 238 239
T15: 240 241 242 243 244 245 246 247 | T31: 248 249 250 251 252 253 254 255

```

则每个线程寄存器所存储的内容如下
```
R0:                                                     | R2:
[T0]: 0   1   [T1]: 2   3   [T2]: 4   5   [T3]: 6   7   | [T0]: 8   9   [T1]: 10  11  [T2]: 12  13  [T3]: 14  15
[T4]: 16  17  [T5]: 18  19  [T6]: 20  21  [T7]: 22  23  | [T4]: 24  25  [T5]: 26  27  [T6]: 28  29  [T7]: 30  31
[T8]: 32  33  [T9]: 34  35  [T10]:36  37  [T11]:38  39  | [T8]: 40  41  [T9]: 42  43  [T10]:44  45  [T11]:46  47
[T12]:48  49  [T13]:50  51  [T14]:52  53  [T15]:54  55  | [T12]:56  57  [T13]:58  59  [T14]:60  61  [T15]:62  63
[T16]:64  65  [T17]:66  67  [T18]:68  69  [T19]:70  71  | [T16]:72  73  [T17]:74  75  [T18]:76  77  [T19]:78  79
[T20]:80  81  [T21]:82  83  [T22]:84  85  [T23]:86  87  | [T20]:88  89  [T21]:90  91  [T22]:92  93  [T23]:94  95
[T24]:96  97  [T25]:98  99  [T26]:100 101 [T27]:102 103 | [T24]:104 105 [T25]:106 107 [T26]:108 109 [T27]:110 111
[T28]:112 113 [T29]:114 115 [T30]:116 117 [T31]:118 119 | [T28]:120 121 [T29]:122 123 [T30]:124 125 [T31]:126 127
---------------------------------------------------------------------------------------------------------------
R0:                                                     | R3:
[T0]: 128 129 [T1]: 130 131 [T2]: 132 133 [T3]: 134 135 | [T0]: 136 137 [T1]: 138 139 [T2]: 140 141 [T3]: 142 143
[T4]: 144 145 [T5]: 146 147 [T6]: 148 149 [T7]: 150 151 | [T4]: 152 153 [T5]: 154 155 [T6]: 156 157 [T7]: 158 159
[T8]: 160 161 [T9]: 162 163 [T10]:164 165 [T11]:166 167 | [T8]: 168 169 [T9]: 170 171 [T10]:172 173 [T11]:174 175
[T12]:176 177 [T13]:178 179 [T14]:180 181 [T15]:182 183 | [T12]:184 185 [T13]:186 187 [T14]:188 189 [T15]:190 191
[T16]:192 193 [T17]:194 195 [T18]:196 197 [T19]:198 199 | [T16]:200 201 [T17]:202 203 [T18]:204 205 [T19]:206 207
[T20]:208 209 [T21]:210 211 [T22]:212 213 [T23]:214 215 | [T20]:216 217 [T21]:218 219 [T22]:220 221 [T23]:222 223
[T24]:224 225 [T25]:226 227 [T26]:228 229 [T27]:230 231 | [T24]:232 233 [T25]:234 235 [T26]:236 237 [T27]:238 239
[T28]:240 241 [T29]:242 243 [T30]:244 245 [T31]:246 247 | [T28]:248 249 [T29]:250 251 [T30]:252 253 [T31]:254 255
```
即 T0 所持有的首地址，会给 T0, T1, T2, T3 的共同读取
即 T11 所持有的首地址，会给 T12, T13, T14, T15 的共同读取

注：所有的读取都是一个warp内进行的，由于读取的数据量超过了4\*32 Bytes的上限，会拆成4个wavefronts。T0~T7执行一次wavefronts时，明显
    可以看出bank conflict影响较大。可以通过swizzle方式避免，这里不再介绍。

## ldmatrix.sync.aligned.m8n8.x1
如果shared memory和每个线程持有首地址同前面保持一致
使用`ldmatrix.sync.aligned.m8n8.x1` 加载后的内容如下
```
[T0]: 0   1   [T1]: 2   3   [T2]: 4   5   [T3]: 6   7
[T4]: 16  17  [T5]: 18  19  [T6]: 20  21  [T7]: 22  23
[T8]: 32  33  [T9]: 34  35  [T10]:36  37  [T11]:38  39
[T12]:48  49  [T13]:50  51  [T14]:52  53  [T15]:54  55
[T16]:64  65  [T17]:66  67  [T18]:68  69  [T19]:70  71
[T20]:80  81  [T21]:82  83  [T22]:84  85  [T23]:86  87
[T24]:96  97  [T25]:98  99  [T26]:100 101 [T27]:102 103
[T28]:112 113 [T29]:114 115 [T30]:116 117 [T31]:118 119
```

## ldmatrix.sync.aligned.trans.m8n8.x4
可以这样简单理解: 先将shared memory中的内容转置，然后在使用 `ldmatrix.sync.aligned.m8n8.x4` 加载
即可得到直接使用 `ldmatrix.sync.aligned.trans.m8n8.x4` 指令加载同样的效果

```
R0:                                                     | R1:
[T0]: 0   16  [T1]: 32  48  [T2]: 64  80  [T3]: 96  112 | [T0]: 128 144 [T1]: 160 176 [T2]: 192 208 [T3]: 224 240
[T4]: 1   17  [T5]: 33  49  [T6]: 65  81  [T7]: 97  113 | [T4]: 129 145 [T5]: 161 177 [T6]: 193 209 [T7]: 225 241
[T8]: 2   18  [T9]: 34  50  [T10]:66  82  [T11]:98  114 | [T8]: 130 146 [T9]: 162 178 [T10]:194 210 [T11]:226 242
[T12]:3   19  [T13]:35  51  [T14]:67  83  [T15]:99  115 | [T12]:131 147 [T13]:163 179 [T14]:195 211 [T15]:227 243
[T16]:4   20  [T17]:36  52  [T18]:68  84  [T19]:100 116 | [T16]:132 148 [T17]:164 180 [T18]:196 212 [T19]:228 244
[T20]:5   21  [T21]:37  53  [T22]:69  85  [T23]:101 117 | [T20]:133 149 [T21]:165 181 [T22]:197 213 [T23]:229 245
[T24]:6   22  [T25]:38  54  [T26]:70  86  [T27]:102 118 | [T24]:134 150 [T25]:166 182 [T26]:198 214 [T27]:230 246
[T28]:7   23  [T29]:39  55  [T30]:71  87  [T31]:103 119 | [T28]:135 151 [T29]:167 183 [T30]:199 215 [T31]:231 247
---------------------------------------------------------------------------------------------------------------
R2:                                                     | R3:
[T0]: 8   24  [T1]: 40  56  [T2]: 72  88  [T3]: 104 120 | [T0]: 136 152 [T1]: 168 184 [T2]: 200 216 [T3]: 232 248
[T4]: 9   25  [T5]: 41  57  [T6]: 73  89  [T7]: 105 121 | [T4]: 137 153 [T5]: 169 185 [T6]: 201 217 [T7]: 233 249
[T8]: 10  26  [T9]: 42  58  [T10]:74  90  [T11]:106 122 | [T8]: 138 154 [T9]: 170 186 [T10]:202 218 [T11]:234 250
[T12]:11  27  [T13]:43  59  [T14]:75  91  [T15]:107 123 | [T12]:139 155 [T13]:171 187 [T14]:203 219 [T15]:235 251
[T16]:12  28  [T17]:44  60  [T18]:76  92  [T19]:108 124 | [T16]:140 156 [T17]:172 188 [T18]:204 220 [T19]:236 252
[T20]:13  29  [T21]:45  61  [T22]:77  93  [T23]:109 125 | [T20]:141 157 [T21]:173 189 [T22]:205 221 [T23]:237 253
[T24]:14  30  [T25]:46  62  [T26]:78  94  [T27]:110 126 | [T24]:142 158 [T25]:174 190 [T26]:206 222 [T27]:238 254
[T28]:15  31  [T29]:47  63  [T30]:79  95  [T31]:111 127 | [T28]:143 159 [T29]:175 191 [T30]:207 223 [T31]:239 255
```
